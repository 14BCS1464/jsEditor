<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeBook â€” JS/TS DSA Notebook</title>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/typescript/5.3.3/typescript.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/comment/comment.min.js"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg: #080810;
            --surface: #0f0f18;
            --card: #13131c;
            --card2: #171720;
            --border: #21212e;
            --border2: #2a2a38;
            --accent: #7c3aed;
            --accent2: #06b6d4;
            --accent3: #f59e0b;
            --accent4: #ec4899;
            --success: #10b981;
            --error: #ef4444;
            --text: #e2e8f0;
            --text2: #94a3b8;
            --muted: #4b5563;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Syne', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse 60% 40% at 10% 10%, rgba(124, 58, 237, 0.07) 0%, transparent 60%),
                radial-gradient(ellipse 50% 40% at 90% 85%, rgba(6, 182, 212, 0.05) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        header {
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            height: 56px;
            background: rgba(8, 8, 16, 0.95);
            backdrop-filter: blur(24px);
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 9px;
            font-size: 1.15rem;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .logo-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .tab-btn {
            padding: 5px 13px;
            border-radius: 7px;
            font-family: 'Syne', sans-serif;
            font-size: 0.77rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid transparent;
            color: var(--text2);
            background: transparent;
            transition: all 0.15s;
        }

        .tab-btn:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.04);
        }

        .tab-btn.active {
            background: rgba(124, 58, 237, 0.18);
            border-color: rgba(124, 58, 237, 0.35);
            color: var(--text);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 7px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 7px;
            font-family: 'Syne', sans-serif;
            font-size: 0.77rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.15s;
        }

        .btn-ghost {
            background: transparent;
            border-color: var(--border2);
            color: var(--text2);
        }

        .btn-ghost:hover {
            border-color: var(--accent);
            color: var(--text);
            background: rgba(124, 58, 237, 0.08);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .btn-primary:hover {
            background: #6d28d9;
            transform: translateY(-1px);
            box-shadow: 0 4px 18px rgba(124, 58, 237, 0.4);
        }

        .btn-sm {
            padding: 3px 9px;
            font-size: 0.7rem;
        }

        .btn-danger {
            background: transparent;
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--error);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--error);
        }

        .firebase-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
            color: var(--muted);
            font-family: 'Space Mono', monospace;
        }

        .firebase-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--muted);
            transition: background 0.3s;
        }

        .firebase-dot.connected {
            background: var(--success);
            box-shadow: 0 0 6px var(--success);
        }

        /* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .app-layout {
            display: grid;
            grid-template-columns: 255px 1fr;
            min-height: calc(100vh - 56px);
            position: relative;
            z-index: 1;
        }

        /* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sidebar {
            border-right: 1px solid var(--border);
            background: rgba(13, 13, 20, 0.8);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 56px;
            height: calc(100vh - 56px);
            overflow: hidden;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-tab {
            flex: 1;
            padding: 9px 6px;
            text-align: center;
            font-size: 0.67rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            cursor: pointer;
            color: var(--muted);
            border-bottom: 2px solid transparent;
            background: transparent;
            border-top: none;
            border-left: none;
            border-right: none;
            font-family: 'Space Mono', monospace;
            transition: all 0.15s;
        }

        .sidebar-tab:hover {
            color: var(--text2);
        }

        .sidebar-tab.active {
            color: var(--accent2);
            border-bottom-color: var(--accent2);
        }

        .sidebar-panel {
            flex: 1;
            overflow-y: auto;
            display: none;
            flex-direction: column;
        }

        .sidebar-panel.active {
            display: flex;
        }

        .panel-toolbar {
            padding: 10px 11px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 5px;
        }

        .nb-list {
            flex: 1;
            overflow-y: auto;
            padding: 5px;
        }

        .nb-item {
            padding: 8px 10px;
            border-radius: 7px;
            cursor: pointer;
            transition: background 0.12s;
            border: 1px solid transparent;
            margin-bottom: 2px;
        }

        .nb-item:hover {
            background: rgba(124, 58, 237, 0.07);
            border-color: var(--border2);
        }

        .nb-item.active {
            background: rgba(124, 58, 237, 0.14);
            border-color: rgba(124, 58, 237, 0.35);
        }

        .nb-item-title {
            font-size: 0.78rem;
            font-weight: 600;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nb-item-meta {
            font-size: 0.64rem;
            color: var(--muted);
            font-family: 'Space Mono', monospace;
        }

        /* DSA sidebar */
        .dsa-toolbar {
            padding: 10px 11px;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 7px;
        }

        .dsa-search {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 9px;
            color: var(--text);
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            outline: none;
            width: 100%;
        }

        .dsa-search:focus {
            border-color: var(--accent2);
        }

        .dsa-filters {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 2px 7px;
            border-radius: 20px;
            font-size: 0.62rem;
            font-weight: 700;
            cursor: pointer;
            border: 1px solid var(--border2);
            background: transparent;
            color: var(--muted);
            font-family: 'Space Mono', monospace;
            transition: all 0.12s;
        }

        .filter-chip.f-all {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(124, 58, 237, 0.1);
        }

        .filter-chip.f-easy {
            border-color: var(--success);
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .filter-chip.f-medium {
            border-color: var(--accent3);
            color: var(--accent3);
            background: rgba(245, 158, 11, 0.1);
        }

        .filter-chip.f-hard {
            border-color: var(--error);
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .dsa-stats {
            display: flex;
            gap: 8px;
            font-size: 0.63rem;
            font-family: 'Space Mono', monospace;
            color: var(--muted);
        }

        .dsa-stats span {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .stat-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }

        .dsa-list {
            flex: 1;
            overflow-y: auto;
            padding: 5px;
        }

        .dsa-item {
            padding: 9px 10px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid transparent;
            margin-bottom: 3px;
            transition: all 0.12s;
            background: var(--card);
        }

        .dsa-item:hover {
            border-color: var(--border2);
            background: var(--card2);
        }

        .dsa-item.solved {
            opacity: 0.6;
        }

        .dsa-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
            margin-bottom: 4px;
        }

        .dsa-item-title {
            font-size: 0.76rem;
            font-weight: 600;
            flex: 1;
            line-height: 1.3;
        }

        .dsa-item-actions {
            display: flex;
            gap: 3px;
            opacity: 0;
            transition: opacity 0.12s;
        }

        .dsa-item:hover .dsa-item-actions {
            opacity: 1;
        }

        .dsa-action-btn {
            width: 19px;
            height: 19px;
            border-radius: 4px;
            border: none;
            background: rgba(255, 255, 255, 0.06);
            color: var(--text2);
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dsa-action-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .dsa-item-footer {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .diff-badge {
            font-size: 0.58rem;
            padding: 1px 5px;
            border-radius: 3px;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            text-transform: uppercase;
        }

        .diff-easy {
            background: rgba(16, 185, 129, 0.12);
            color: var(--success);
        }

        .diff-medium {
            background: rgba(245, 158, 11, 0.12);
            color: var(--accent3);
        }

        .diff-hard {
            background: rgba(239, 68, 68, 0.12);
            color: var(--error);
        }

        .dsa-category {
            font-size: 0.62rem;
            color: var(--muted);
            font-family: 'Space Mono', monospace;
        }

        .dsa-linked-count {
            font-size: 0.6rem;
            color: var(--accent2);
            font-family: 'Space Mono', monospace;
            margin-left: auto;
        }

        .dsa-bottom {
            padding: 10px 11px;
            border-top: 1px solid var(--border);
        }

        /* â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(6px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background: var(--card2);
            border: 1px solid var(--border2);
            border-radius: 16px;
            padding: 26px;
            width: 490px;
            max-width: 95vw;
            transform: translateY(14px);
            transition: transform 0.2s;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-overlay.open .modal {
            transform: translateY(0);
        }

        .modal h2 {
            font-size: 1.1rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .modal>p {
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            font-size: 0.68rem;
            color: var(--muted);
            margin-bottom: 4px;
            font-family: 'Space Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 7px;
            padding: 8px 10px;
            color: var(--text);
            font-family: 'Syne', sans-serif;
            font-size: 0.8rem;
            outline: none;
            transition: border-color 0.15s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--accent);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--muted);
        }

        .form-group select option {
            background: var(--card2);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
            font-family: 'Space Mono', monospace;
            font-size: 0.76rem;
        }

        .radio-group {
            display: flex;
            gap: 7px;
        }

        .radio-option {
            flex: 1;
            padding: 7px;
            border-radius: 7px;
            border: 1px solid var(--border2);
            background: transparent;
            color: var(--text2);
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            font-size: 0.68rem;
            font-weight: 700;
            text-transform: uppercase;
            text-align: center;
            transition: all 0.12s;
        }

        .radio-option.sel-easy {
            border-color: var(--success);
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .radio-option.sel-medium {
            border-color: var(--accent3);
            color: var(--accent3);
            background: rgba(245, 158, 11, 0.1);
        }

        .radio-option.sel-hard {
            border-color: var(--error);
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 7px;
            margin-top: 16px;
        }

        /* â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .main-content {
            min-height: calc(100vh - 56px);
            display: flex;
            flex-direction: column;
        }

        .page {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .page.active {
            display: flex;
        }

        /* Notebook page */
        .notebook-page {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 26px 22px;
        }

        .notebook-header {
            margin-bottom: 24px;
        }

        .notebook-title-input {
            background: transparent;
            border: none;
            outline: none;
            font-family: 'Syne', sans-serif;
            font-size: 1.9rem;
            font-weight: 800;
            color: var(--text);
            width: 100%;
            padding: 3px 0;
            border-bottom: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .notebook-title-input:focus {
            border-bottom-color: var(--accent);
        }

        .notebook-title-input::placeholder {
            color: var(--muted);
        }

        .notebook-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 6px;
            font-size: 0.7rem;
            color: var(--muted);
            font-family: 'Space Mono', monospace;
        }

        /* â”€â”€ CELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #cells-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .cell {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: border-color 0.2s, box-shadow 0.2s;
            animation: cellIn 0.25s ease;
        }

        @keyframes cellIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .cell:hover {
            border-color: var(--border2);
        }

        .cell.focused {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(124, 58, 237, 0.18);
        }

        /* â”€â”€ Question Banner (top of cell) â”€â”€â”€â”€â”€â”€â”€â”€ */
        .cell-qbanner {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 14px;
            min-height: 40px;
            background: rgba(30, 30, 46, 0.6);
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .cell-qbanner.linked {
            background: linear-gradient(90deg, rgba(124, 58, 237, 0.07), rgba(6, 182, 212, 0.04));
            border-bottom-color: rgba(124, 58, 237, 0.2);
        }

        .qb-icon {
            font-size: 12px;
            flex-shrink: 0;
        }

        .qb-info {
            flex: 1;
            min-width: 0;
        }

        .qb-sublabel {
            font-size: 0.58rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            font-family: 'Space Mono', monospace;
            margin-bottom: 1px;
        }

        .qb-title {
            font-size: 0.77rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .qb-meta {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 2px;
        }

        .qb-empty {
            font-size: 0.74rem;
            color: var(--muted);
        }

        .qb-dropdown-wrap {
            position: relative;
            flex-shrink: 0;
        }

        .qb-link-btn {
            padding: 3px 9px;
            border-radius: 5px;
            font-size: 0.65rem;
            font-weight: 700;
            cursor: pointer;
            border: 1px dashed var(--border2);
            background: transparent;
            color: var(--muted);
            font-family: 'Space Mono', monospace;
            transition: all 0.12s;
            white-space: nowrap;
        }

        .qb-link-btn:hover {
            border-color: var(--accent3);
            color: var(--accent3);
            border-style: solid;
        }

        .qb-link-btn.is-linked {
            border-style: solid;
            border-color: rgba(124, 58, 237, 0.4);
            color: var(--accent);
        }

        .qb-picker {
            position: absolute;
            top: calc(100% + 5px);
            right: 0;
            background: var(--card2);
            border: 1px solid var(--border2);
            border-radius: 9px;
            z-index: 200;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
            width: 290px;
            animation: dropIn 0.14s ease;
        }

        @keyframes dropIn {
            from {
                opacity: 0;
                transform: translateY(-5px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .qb-psearch {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
        }

        .qb-psearch input {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 5px 8px;
            color: var(--text);
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            outline: none;
        }

        .qb-psearch input:focus {
            border-color: var(--accent);
        }

        .qb-plist {
            max-height: 190px;
            overflow-y: auto;
        }

        .qb-pitem {
            padding: 7px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 7px;
            transition: background 0.1s;
            font-size: 0.76rem;
        }

        .qb-pitem:hover {
            background: rgba(124, 58, 237, 0.09);
        }

        .qb-pitem.selected {
            background: rgba(124, 58, 237, 0.15);
        }

        .qb-pitem-name {
            flex: 1;
            font-weight: 600;
        }

        .qb-pempty {
            padding: 12px;
            text-align: center;
            color: var(--muted);
            font-size: 0.72rem;
            font-family: 'Space Mono', monospace;
        }

        .qb-unlink {
            padding: 2px 7px;
            border-radius: 4px;
            font-size: 0.6rem;
            cursor: pointer;
            border: 1px solid rgba(239, 68, 68, 0.3);
            background: transparent;
            color: var(--error);
            font-family: 'Space Mono', monospace;
            flex-shrink: 0;
        }

        .qb-unlink:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* â”€â”€ Description â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .cell-desc {
            padding: 11px 14px;
            background: rgba(6, 182, 212, 0.03);
            border-bottom: 1px solid var(--border);
        }

        .desc-label {
            font-size: 0.58rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--accent2);
            font-family: 'Space Mono', monospace;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .desc-ta {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            resize: none;
            color: var(--text);
            font-family: 'Syne', sans-serif;
            font-size: 0.83rem;
            line-height: 1.6;
            min-height: 34px;
        }

        .desc-ta::placeholder {
            color: var(--muted);
        }

        /* â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .cell-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 7px;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .cell-num {
            font-family: 'Space Mono', monospace;
            font-size: 0.63rem;
            color: var(--muted);
            background: var(--bg);
            padding: 2px 7px;
            border-radius: 4px;
            min-width: 28px;
            text-align: center;
        }

        .lang-toggle {
            display: flex;
            background: var(--bg);
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .lang-btn {
            padding: 2px 9px;
            font-size: 0.66rem;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--muted);
            transition: all 0.12s;
        }

        .lang-btn.active {
            background: var(--accent);
            color: white;
        }

        .hint-text {
            font-size: 0.62rem;
            color: var(--muted);
            font-family: 'Space Mono', monospace;
        }

        .run-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            font-family: 'Syne', sans-serif;
            font-size: 0.73rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
        }

        .run-btn:hover {
            background: #6d28d9;
            transform: translateY(-1px);
        }

        .run-btn.running {
            background: var(--muted);
            cursor: not-allowed;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .5
            }
        }

        .icon-btn {
            background: transparent;
            border: 1px solid var(--border2);
            color: var(--muted);
            width: 25px;
            height: 25px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.12s;
        }

        .icon-btn:hover {
            border-color: var(--error);
            color: var(--error);
        }

        /* â”€â”€ Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .cell-editor-wrap .CodeMirror {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.845rem;
            line-height: 1.65;
            height: auto;
            min-height: 72px;
            background: var(--card) !important;
            padding: 9px 0;
        }

        .cell-editor-wrap .CodeMirror-scroll {
            min-height: 72px;
        }

        .cell-editor-wrap .CodeMirror-lines {
            padding: 0 13px;
        }

        /* â”€â”€ Output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .cell-output {
            border-top: 1px solid var(--border);
            background: var(--bg);
        }

        .out-header {
            font-size: 0.58rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--muted);
            font-family: 'Space Mono', monospace;
            padding: 6px 13px 4px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 7px;
        }

        .out-async-badge {
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.56rem;
            background: rgba(6, 182, 212, 0.12);
            color: var(--accent2);
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        .out-time {
            margin-left: auto;
            color: var(--accent3);
        }

        .out-content {
            padding: 9px 13px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.79rem;
            line-height: 1.7;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .out-content.has-error {
            border-left: 3px solid var(--error);
        }

        .out-content.has-success {
            border-left: 3px solid var(--success);
        }

        .log-line {
            color: var(--text);
        }

        .error-line {
            color: var(--error);
        }

        .warn-line {
            color: var(--accent3);
        }

        .info-line {
            color: var(--accent2);
        }

        .return-line {
            color: #a78bfa;
        }

        /* â”€â”€ Add cell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .add-cell-row {
            display: flex;
            gap: 9px;
            margin-top: 4px;
            padding: 12px 0;
        }

        .add-cell-btn {
            flex: 1;
            background: transparent;
            border: 1px dashed var(--border2);
            border-radius: 9px;
            padding: 10px;
            color: var(--muted);
            font-family: 'Syne', sans-serif;
            font-size: 0.76rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.18s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .add-cell-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(124, 58, 237, 0.05);
        }

        .add-cell-btn.ts:hover {
            border-color: var(--accent2);
            color: var(--accent2);
            background: rgba(6, 182, 212, 0.05);
        }

        /* â”€â”€ DSA PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .dsa-page {
            padding: 26px;
            max-width: 880px;
            width: 100%;
            margin: 0 auto;
        }

        .dsa-page-header {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            margin-bottom: 22px;
        }

        .dsa-page-title {
            font-size: 1.5rem;
            font-weight: 800;
        }

        .dsa-page-title span {
            color: var(--accent2);
        }

        .dsa-page-meta {
            font-size: 0.72rem;
            color: var(--muted);
            font-family: 'Space Mono', monospace;
            margin-top: 3px;
        }

        .dsa-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(265px, 1fr));
            gap: 13px;
        }

        .dsa-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 11px;
            padding: 15px;
            cursor: default;
            transition: all 0.18s;
            animation: cellIn 0.22s ease;
        }

        .dsa-card:hover {
            border-color: var(--border2);
            transform: translateY(-2px);
            box-shadow: 0 8px 28px rgba(0, 0, 0, 0.3);
        }

        .dsa-card.solved-card {
            opacity: 0.68;
        }

        .dsa-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 7px;
            margin-bottom: 7px;
        }

        .dsa-card-num {
            font-size: 0.62rem;
            font-family: 'Space Mono', monospace;
            color: var(--muted);
            flex-shrink: 0;
            margin-top: 2px;
        }

        .dsa-card-title {
            font-size: 0.88rem;
            font-weight: 700;
            flex: 1;
            line-height: 1.3;
        }

        .dsa-card-check {
            color: var(--success);
            font-size: 13px;
            flex-shrink: 0;
        }

        .dsa-card-desc {
            font-size: 0.73rem;
            color: var(--text2);
            line-height: 1.5;
            margin-bottom: 9px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .dsa-card-footer {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .dsa-card-linked {
            margin-left: auto;
            font-size: 0.62rem;
            color: var(--accent2);
            font-family: 'Space Mono', monospace;
            background: rgba(6, 182, 212, 0.08);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .dsa-card-actions {
            display: flex;
            gap: 5px;
            margin-top: 9px;
        }

        .empty-state {
            grid-column: 1/-1;
            text-align: center;
            padding: 56px 20px;
            color: var(--muted);
        }

        .empty-icon {
            font-size: 2.8rem;
            margin-bottom: 10px;
            opacity: 0.35;
        }

        .empty-state p {
            font-size: 0.82rem;
        }

        /* â”€â”€ SAVE BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .save-bar {
            position: fixed;
            bottom: 18px;
            right: 18px;
            display: flex;
            align-items: center;
            gap: 7px;
            background: var(--card2);
            border: 1px solid var(--border2);
            border-radius: 9px;
            padding: 9px 14px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            font-size: 0.72rem;
            z-index: 50;
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.25s;
            font-family: 'Space Mono', monospace;
        }

        .save-bar.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .save-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent3);
        }

        .save-dot.saved {
            background: var(--success);
        }

        /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .toast {
            position: fixed;
            top: 68px;
            right: 18px;
            background: var(--card2);
            border: 1px solid var(--border2);
            border-radius: 8px;
            padding: 8px 13px;
            font-size: 0.74rem;
            z-index: 500;
            opacity: 0;
            transform: translateX(14px);
            transition: all 0.22s;
            pointer-events: none;
            font-family: 'Space Mono', monospace;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            border-color: var(--success);
            color: var(--success);
        }

        .toast.error {
            border-color: var(--error);
            color: var(--error);
        }

        ::-webkit-scrollbar {
            width: 3px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border2);
            border-radius: 2px;
        }
    </style>
</head>

<body>

    <div class="toast" id="toast"></div>

    <!-- HEADER -->
    <header>
        <div class="logo">
            <div class="logo-icon">âš¡</div>
            CodeBook
        </div>
        <div class="header-center">
            <button class="tab-btn active" id="tab-notebook" onclick="switchPage('notebook')">ğŸ““ Notebook</button>
            <button class="tab-btn" id="tab-dsa" onclick="switchPage('dsa')">ğŸ¯ DSA Questions</button>
        </div>
        <div class="header-actions">
            <div class="firebase-status">
                <div class="firebase-dot" id="fb-dot"></div>
                <span id="fb-status">offline</span>
            </div>
            <button class="btn btn-ghost btn-sm" onclick="openFirebaseModal()">âš™ Firebase</button>
            <button class="btn btn-primary btn-sm" onclick="saveAll()">ğŸ’¾ Save</button>
        </div>
    </header>

    <div class="app-layout">

        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" id="stab-nb" onclick="switchSidebarTab('nb')">Notebooks</button>
                <button class="sidebar-tab" id="stab-dsa" onclick="switchSidebarTab('dsa')">DSA List</button>
            </div>

            <!-- Notebooks panel -->
            <div class="sidebar-panel active" id="spanel-nb">
                <div class="panel-toolbar">
                    <button class="btn btn-primary" style="width:100%;justify-content:center" onclick="newNotebook()">ï¼‹
                        New Notebook</button>
                </div>
                <div class="nb-list" id="nb-list">
                    <div
                        style="padding:14px;color:var(--muted);font-size:0.72rem;text-align:center;font-family:'Space Mono',monospace">
                        Connect Firebase to sync</div>
                </div>
            </div>

            <!-- DSA sidebar panel -->
            <div class="sidebar-panel" id="spanel-dsa">
                <div class="dsa-toolbar">
                    <input class="dsa-search" id="sb-dsa-search" placeholder="Search questions..."
                        oninput="renderDSASidebar()">
                    <div class="dsa-filters">
                        <button class="filter-chip f-all" id="fc-all" onclick="setFilter('all')">All</button>
                        <button class="filter-chip" id="fc-easy" onclick="setFilter('easy')">Easy</button>
                        <button class="filter-chip" id="fc-medium" onclick="setFilter('medium')">Med</button>
                        <button class="filter-chip" id="fc-hard" onclick="setFilter('hard')">Hard</button>
                        <button class="filter-chip" id="fc-unsolved" onclick="setFilter('unsolved')">Todo</button>
                    </div>
                    <div class="dsa-stats">
                        <span><span class="stat-dot" style="background:var(--success)"></span><span
                                id="stat-easy">0</span></span>
                        <span><span class="stat-dot" style="background:var(--accent3)"></span><span
                                id="stat-med">0</span></span>
                        <span><span class="stat-dot" style="background:var(--error)"></span><span
                                id="stat-hard">0</span></span>
                        <span>solved: <span id="stat-solved">0</span></span>
                    </div>
                </div>
                <div class="dsa-list" id="sb-dsa-list"></div>
                <div class="dsa-bottom">
                    <button class="btn btn-primary" style="width:100%;justify-content:center" onclick="openDSAModal()">ï¼‹
                        Add Question</button>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <div class="main-content">

            <!-- NOTEBOOK PAGE -->
            <div class="page active" id="page-notebook">
                <div class="notebook-page">
                    <div class="notebook-header">
                        <input class="notebook-title-input" id="nb-title" type="text" placeholder="Untitled Notebook"
                            value="Untitled Notebook">
                        <div class="notebook-meta">
                            <span id="nb-id">local</span>
                            <span>Â·</span>
                            <span id="cell-count">0 cells</span>
                            <span>Â·</span>
                            <span id="last-saved">unsaved</span>
                        </div>
                    </div>
                    <div id="cells-container"></div>
                    <div class="add-cell-row">
                        <button class="add-cell-btn" onclick="addCell('javascript')">ï¼‹ JS Cell</button>
                        <button class="add-cell-btn ts" onclick="addCell('typescript')">ï¼‹ TS Cell</button>
                    </div>
                </div>
            </div>

            <!-- DSA PAGE -->
            <div class="page" id="page-dsa">
                <div class="dsa-page">
                    <div class="dsa-page-header">
                        <div>
                            <div class="dsa-page-title">DSA <span>Questions</span></div>
                            <div class="dsa-page-meta" id="dsa-page-meta">0 questions</div>
                        </div>
                        <button class="btn btn-primary" onclick="openDSAModal()">ï¼‹ Add Question</button>
                    </div>
                    <div class="dsa-grid" id="dsa-grid">
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ¯</div>
                            <p>Add your first DSA question!</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- FIREBASE MODAL -->
    <div class="modal-overlay" id="firebase-modal">
        <div class="modal">
            <h2>ğŸ”¥ Firebase Config</h2>
            <p>Enter your Firebase project credentials to enable cloud sync.</p>
            <div class="form-group"><label>API Key</label><input type="text" id="fb-apiKey" placeholder="AIzaSy...">
            </div>
            <div class="form-group"><label>Auth Domain</label><input type="text" id="fb-authDomain"
                    placeholder="project.firebaseapp.com"></div>
            <div class="form-group"><label>Project ID</label><input type="text" id="fb-projectId"
                    placeholder="my-project"></div>
            <div class="form-group"><label>Storage Bucket</label><input type="text" id="fb-storageBucket"
                    placeholder="my-project.appspot.com"></div>
            <div class="form-group"><label>Messaging Sender ID</label><input type="text" id="fb-messagingSenderId"
                    placeholder="123456789"></div>
            <div class="form-group"><label>App ID</label><input type="text" id="fb-appId" placeholder="1:123..."></div>
            <div class="modal-actions">
                <button class="btn btn-ghost" onclick="closeModal('firebase-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="initFirebase()">Connect</button>
            </div>
        </div>
    </div>

    <!-- DSA QUESTION MODAL -->
    <div class="modal-overlay" id="dsa-modal">
        <div class="modal">
            <h2 id="dsa-modal-h">ï¼‹ Add DSA Question</h2>
            <p>Track a question in your practice list.</p>
            <input type="hidden" id="dsa-edit-id">
            <div class="form-group"><label>Title *</label><input type="text" id="dq-title" placeholder="e.g. Two Sum">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="dq-cat">
                    <option>Array</option>
                    <option>String</option>
                    <option>Linked List</option>
                    <option>Tree</option>
                    <option>Graph</option>
                    <option>Dynamic Programming</option>
                    <option>Backtracking</option>
                    <option>Binary Search</option>
                    <option>Stack / Queue</option>
                    <option>Heap</option>
                    <option>Sliding Window</option>
                    <option>Two Pointers</option>
                    <option>Recursion</option>
                    <option>Math</option>
                    <option>Bit Manipulation</option>
                    <option>Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Difficulty</label>
                <div class="radio-group">
                    <button class="radio-option" id="rd-easy" onclick="pickDiff('easy')">Easy</button>
                    <button class="radio-option" id="rd-medium" onclick="pickDiff('medium')">Medium</button>
                    <button class="radio-option" id="rd-hard" onclick="pickDiff('hard')">Hard</button>
                </div>
            </div>
            <div class="form-group"><label>Problem Description</label><textarea id="dq-desc"
                    placeholder="Briefly describe the problem..." rows="3"></textarea></div>
            <div class="form-group"><label>Source URL (LeetCode, etc.)</label><input type="text" id="dq-url"
                    placeholder="https://leetcode.com/problems/..."></div>
            <div class="modal-actions">
                <button class="btn btn-ghost" onclick="closeModal('dsa-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveDSAQuestion()">Save</button>
            </div>
        </div>
    </div>

    <!-- SAVE BAR -->
    <div class="save-bar" id="save-bar">
        <div class="save-dot" id="save-dot"></div>
        <span id="save-text">Saved</span>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let db = null;
        let cells = [];
        let cellEditors = {};
        let dsaQuestions = [];
        let currentNotebookId = null;
        let autoSaveTimer = null;
        let cellIdCounter = 0;
        let dsaFilter = 'all';
        let selDiff = 'medium';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PAGE SWITCHING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function switchPage(name) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('page-' + name).classList.add('active');
            document.getElementById('tab-' + name).classList.add('active');
            if (name === 'dsa') renderDSAGrid();
        }

        function switchSidebarTab(name) {
            document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.sidebar-tab').forEach(b => b.classList.remove('active'));
            document.getElementById('spanel-' + name).classList.add('active');
            document.getElementById('stab-' + name).classList.add('active');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FIREBASE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function openFirebaseModal() {
            const saved = JSON.parse(localStorage.getItem('fb_config') || '{}');
            ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'].forEach(k => {
                const el = document.getElementById('fb-' + k);
                if (el && saved[k]) el.value = saved[k];
            });
            document.getElementById('firebase-modal').classList.add('open');
        }

        function closeModal(id) { document.getElementById(id).classList.remove('open'); }

        async function initFirebase() {
            const config = {};
            ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'].forEach(k => {
                config[k] = document.getElementById('fb-' + k).value.trim();
            });
            if (!config.apiKey || !config.projectId) { showToast('API Key & Project ID required!', 'error'); return; }
            try {
                try { await firebase.app().delete(); } catch (e) { }
                firebase.initializeApp(config);
                db = firebase.firestore();
                await db.collection('notebooks').limit(1).get();
                localStorage.setItem('fb_config', JSON.stringify(config));
                document.getElementById('fb-dot').classList.add('connected');
                document.getElementById('fb-status').textContent = 'synced';
                closeModal('firebase-modal');
                showToast('Firebase connected!', 'success');
                loadNotebooksList();
                loadDSAFromFirebase();
            } catch (e) { showToast('Failed: ' + e.message, 'error'); }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NOTEBOOKS LIST
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadNotebooksList() {
            if (!db) return;
            const list = document.getElementById('nb-list');
            list.innerHTML = '<div style="padding:12px;color:var(--muted);font-size:0.7rem;font-family:\'Space Mono\',monospace">Loading...</div>';
            try {
                const snap = await db.collection('notebooks').orderBy('updatedAt', 'desc').limit(40).get();
                list.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const div = document.createElement('div');
                    div.className = 'nb-item' + (doc.id === currentNotebookId ? ' active' : '');
                    const date = d.updatedAt && d.updatedAt.toDate ? d.updatedAt.toDate().toLocaleDateString() : '';
                    div.innerHTML = '<div class="nb-item-title">' + (d.title || 'Untitled') + '</div>' +
                        '<div class="nb-item-meta">' + (d.cells || []).length + ' cells Â· ' + date + '</div>';
                    div.onclick = () => loadNotebook(doc.id, d);
                    list.appendChild(div);
                });
                if (snap.empty) list.innerHTML = '<div style="padding:14px;color:var(--muted);font-size:0.7rem;text-align:center;font-family:\'Space Mono\',monospace">No notebooks yet</div>';
            } catch (e) {
                list.innerHTML = '<div style="padding:12px;color:var(--error);font-size:0.7rem">' + e.message + '</div>';
            }
        }

        function loadNotebook(id, data) {
            currentNotebookId = id;
            document.getElementById('nb-title').value = data.title || 'Untitled';
            document.getElementById('nb-id').textContent = id.slice(0, 8) + '...';
            cells = []; cellEditors = {};
            document.getElementById('cells-container').innerHTML = '';
            (data.cells || []).forEach(c => addCell(c.lang, c.code, c.description, c.output, c.linkedQuestionId));
            updateCellCount();
            switchPage('notebook');
            showToast('Notebook loaded!', 'success');
        }

        function newNotebook() {
            currentNotebookId = null;
            document.getElementById('nb-title').value = 'Untitled Notebook';
            document.getElementById('nb-id').textContent = 'local';
            cells = []; cellEditors = {};
            document.getElementById('cells-container').innerHTML = '';
            addCell('javascript');
            showToast('New notebook created', 'success');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DSA QUESTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function pickDiff(d) {
            selDiff = d;
            ['easy', 'medium', 'hard'].forEach(x => {
                const btn = document.getElementById('rd-' + x);
                btn.className = 'radio-option' + (x === d ? ' sel-' + x : '');
            });
        }

        function openDSAModal(editId) {
            document.getElementById('dsa-edit-id').value = editId || '';
            if (editId) {
                const q = dsaQuestions.find(q => q.id === editId);
                if (!q) return;
                document.getElementById('dsa-modal-h').textContent = 'âœ Edit Question';
                document.getElementById('dq-title').value = q.title;
                document.getElementById('dq-cat').value = q.category || 'Array';
                document.getElementById('dq-desc').value = q.description || '';
                document.getElementById('dq-url').value = q.url || '';
                pickDiff(q.difficulty || 'medium');
            } else {
                document.getElementById('dsa-modal-h').textContent = 'ï¼‹ Add DSA Question';
                document.getElementById('dq-title').value = '';
                document.getElementById('dq-desc').value = '';
                document.getElementById('dq-url').value = '';
                pickDiff('medium');
            }
            document.getElementById('dsa-modal').classList.add('open');
        }

        function saveDSAQuestion() {
            const title = document.getElementById('dq-title').value.trim();
            if (!title) { showToast('Title is required!', 'error'); return; }
            const editId = document.getElementById('dsa-edit-id').value;
            const existing = editId ? dsaQuestions.find(q => q.id === editId) : null;
            const q = {
                id: editId || ('dsa_' + Date.now() + '_' + Math.random().toString(36).slice(2, 7)),
                title,
                category: document.getElementById('dq-cat').value,
                difficulty: selDiff,
                description: document.getElementById('dq-desc').value.trim(),
                url: document.getElementById('dq-url').value.trim(),
                solved: existing ? existing.solved : false,
                createdAt: existing ? existing.createdAt : Date.now(),
            };
            if (editId) {
                const idx = dsaQuestions.findIndex(x => x.id === editId);
                if (idx !== -1) dsaQuestions[idx] = q;
            } else {
                dsaQuestions.push(q);
            }
            closeModal('dsa-modal');
            persistDSA();
            renderDSASidebar();
            renderDSAGrid();
            updateDSAStats();
            // refresh banners of linked cells
            cells.forEach(c => { if (c.linkedQuestionId === q.id) refreshBanner(c.id); });
            showToast(editId ? 'Updated!' : 'Question added!', 'success');
        }

        function deleteDSAQuestion(id) {
            if (!confirm('Delete this question?')) return;
            cells.forEach(c => { if (c.linkedQuestionId === id) { c.linkedQuestionId = null; refreshBanner(c.id); } });
            dsaQuestions = dsaQuestions.filter(q => q.id !== id);
            persistDSA();
            renderDSASidebar();
            renderDSAGrid();
            updateDSAStats();
            triggerAutoSave();
        }

        function toggleSolved(id) {
            const q = dsaQuestions.find(q => q.id === id);
            if (q) { q.solved = !q.solved; persistDSA(); renderDSASidebar(); renderDSAGrid(); updateDSAStats(); cells.forEach(c => { if (c.linkedQuestionId === id) refreshBanner(c.id); }); }
        }

        function setFilter(f) {
            dsaFilter = f;
            ['all', 'easy', 'medium', 'hard', 'unsolved'].forEach(x => {
                const el = document.getElementById('fc-' + x);
                if (!el) return;
                const activeClass = x === 'easy' ? 'f-easy' : x === 'medium' ? 'f-medium' : x === 'hard' ? 'f-hard' : 'f-all';
                el.className = 'filter-chip' + (x === f ? ' ' + activeClass : '');
            });
            renderDSASidebar();
        }

        function renderDSASidebar() {
            const list = document.getElementById('sb-dsa-list');
            const search = (document.getElementById('sb-dsa-search').value || '').toLowerCase();
            const filtered = dsaQuestions.filter(q => {
                if (dsaFilter === 'easy' && q.difficulty !== 'easy') return false;
                if (dsaFilter === 'medium' && q.difficulty !== 'medium') return false;
                if (dsaFilter === 'hard' && q.difficulty !== 'hard') return false;
                if (dsaFilter === 'unsolved' && q.solved) return false;
                if (search && !q.title.toLowerCase().includes(search) && !(q.category || '').toLowerCase().includes(search)) return false;
                return true;
            });
            if (filtered.length === 0) {
                list.innerHTML = '<div style="padding:14px;color:var(--muted);font-size:0.7rem;text-align:center;font-family:\'Space Mono\',monospace">No questions found</div>';
                return;
            }
            list.innerHTML = filtered.map(q => {
                const lc = cells.filter(c => c.linkedQuestionId === q.id).length;
                return '<div class="dsa-item' + (q.solved ? ' solved' : '') + '" onclick="openDSAModal(\'' + q.id + '\')">' +
                    '<div class="dsa-item-header"><div class="dsa-item-title">' + escH(q.title) + '</div>' +
                    '<div class="dsa-item-actions"><button class="dsa-action-btn" onclick="event.stopPropagation();deleteDSAQuestion(\'' + q.id + '\')">âœ•</button></div></div>' +
                    '<div class="dsa-item-footer">' +
                    '<span class="diff-badge diff-' + q.difficulty + '">' + q.difficulty + '</span>' +
                    '<span class="dsa-category">' + escH(q.category || '') + '</span>' +
                    (lc ? '<span class="dsa-linked-count">âš¡' + lc + '</span>' : '') +
                    '</div></div>';
            }).join('');
        }

        function renderDSAGrid() {
            const grid = document.getElementById('dsa-grid');
            const meta = document.getElementById('dsa-page-meta');
            meta.textContent = dsaQuestions.length + ' question' + (dsaQuestions.length !== 1 ? 's' : '') + ' Â· ' + dsaQuestions.filter(q => q.solved).length + ' solved';
            if (dsaQuestions.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ¯</div><p>No questions yet. Add your first DSA question!</p></div>';
                return;
            }
            grid.innerHTML = dsaQuestions.map((q, i) => {
                const lc = cells.filter(c => c.linkedQuestionId === q.id).length;
                return '<div class="dsa-card' + (q.solved ? ' solved-card' : '') + '">' +
                    '<div class="dsa-card-header"><span class="dsa-card-num">#' + (i + 1) + '</span>' +
                    '<span class="dsa-card-title">' + escH(q.title) + '</span>' +
                    (q.solved ? '<span class="dsa-card-check">âœ“</span>' : '') + '</div>' +
                    (q.description ? '<div class="dsa-card-desc">' + escH(q.description) + '</div>' : '') +
                    '<div class="dsa-card-footer">' +
                    '<span class="diff-badge diff-' + q.difficulty + '">' + q.difficulty + '</span>' +
                    '<span style="font-size:0.65rem;color:var(--muted);font-family:\'Space Mono\',monospace">' + escH(q.category || '') + '</span>' +
                    (lc ? '<span class="dsa-card-linked">âš¡ ' + lc + ' cell' + (lc > 1 ? 's' : '') + '</span>' : '') + '</div>' +
                    '<div class="dsa-card-actions">' +
                    '<button class="btn btn-ghost btn-sm" onclick="toggleSolved(\'' + q.id + '\')">' + (q.solved ? 'â†© Reopen' : 'âœ“ Solved') + '</button>' +
                    (q.url ? '<button class="btn btn-ghost btn-sm" onclick="window.open(\'' + q.url + '\',\'_blank\')">ğŸ”—</button>' : '') +
                    '<button class="btn btn-ghost btn-sm" onclick="openDSAModal(\'' + q.id + '\')">âœ</button>' +
                    '<button class="btn btn-danger btn-sm" onclick="deleteDSAQuestion(\'' + q.id + '\')">âœ•</button>' +
                    '</div></div>';
            }).join('');
        }

        function updateDSAStats() {
            document.getElementById('stat-easy').textContent = dsaQuestions.filter(q => q.difficulty === 'easy').length;
            document.getElementById('stat-med').textContent = dsaQuestions.filter(q => q.difficulty === 'medium').length;
            document.getElementById('stat-hard').textContent = dsaQuestions.filter(q => q.difficulty === 'hard').length;
            document.getElementById('stat-solved').textContent = dsaQuestions.filter(q => q.solved).length;
        }

        function persistDSA() {
            localStorage.setItem('dsa_questions', JSON.stringify(dsaQuestions));
            if (db) {
                db.collection('dsa').doc('questions').set({ questions: dsaQuestions, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }).catch(() => { });
            }
        }

        async function loadDSAFromFirebase() {
            if (!db) return;
            try {
                const doc = await db.collection('dsa').doc('questions').get();
                if (doc.exists && doc.data().questions) {
                    dsaQuestions = doc.data().questions;
                    localStorage.setItem('dsa_questions', JSON.stringify(dsaQuestions));
                    renderDSASidebar(); renderDSAGrid(); updateDSAStats();
                    cells.forEach(c => refreshBanner(c.id));
                }
            } catch (e) { }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CELLS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function addCell(lang, code, description, savedOutput, linkedQuestionId) {
            lang = lang || 'javascript';
            code = code || '';
            description = description || '';
            linkedQuestionId = linkedQuestionId || null;

            const id = ++cellIdCounter;
            const cell = { id, lang, description, linkedQuestionId, lastOutput: savedOutput || null };
            cells.push(cell);

            const div = document.createElement('div');
            div.className = 'cell';
            div.id = 'cell-' + id;

            div.innerHTML = buildBannerHTML(id, linkedQuestionId) +
                '<div class="cell-desc">' +
                '<div class="desc-label"><span>ğŸ“</span> Solution Notes</div>' +
                '<textarea class="desc-ta" placeholder="Describe your approach, time/space complexity, edge cases..." rows="2">' + escH(description) + '</textarea>' +
                '</div>' +
                '<div class="cell-toolbar">' +
                '<div class="toolbar-left">' +
                '<span class="cell-num" id="cnum-' + id + '">[1]</span>' +
                '<div class="lang-toggle">' +
                '<button class="lang-btn ' + (lang === 'javascript' ? 'active' : '') + '" onclick="setLang(' + id + ',\'javascript\')">JS</button>' +
                '<button class="lang-btn ' + (lang === 'typescript' ? 'active' : '') + '" onclick="setLang(' + id + ',\'typescript\')">TS</button>' +
                '</div>' +
                '<span class="hint-text">Ctrl+Enter run</span>' +
                '</div>' +
                '<div class="toolbar-right">' +
                '<button class="run-btn" id="runbtn-' + id + '" onclick="runCell(' + id + ')">â–¶ Run</button>' +
                '<button class="icon-btn" onclick="deleteCell(' + id + ')">âœ•</button>' +
                '</div>' +
                '</div>' +
                '<div class="cell-editor-wrap" id="edwrap-' + id + '"></div>' +
                '<div class="cell-output" id="output-' + id + '" style="display:none">' +
                '<div class="out-header">Output <span class="out-async-badge" id="oasync-' + id + '" style="display:none">async</span><span class="out-time" id="otime-' + id + '"></span></div>' +
                '<div class="out-content" id="ocontent-' + id + '"></div>' +
                '</div>';

            document.getElementById('cells-container').appendChild(div);

            // CodeMirror
            const editor = CodeMirror(document.getElementById('edwrap-' + id), {
                value: code || getTemplate(lang),
                mode: 'javascript', theme: 'dracula', lineNumbers: true,
                matchBrackets: true, autoCloseBrackets: true,
                extraKeys: {
                    'Ctrl-Enter': () => runCell(id),
                    'Cmd-Enter': () => runCell(id),
                    'Ctrl-/': cm => cm.execCommand('toggleComment'),
                },
                indentUnit: 2, tabSize: 2, indentWithTabs: false,
            });
            editor.on('focus', () => { div.classList.add('focused'); closeAllPickers(); });
            editor.on('blur', () => div.classList.remove('focused'));
            editor.on('change', () => triggerAutoSave());
            cellEditors[id] = editor;

            div.querySelector('.desc-ta').addEventListener('input', triggerAutoSave);

            if (savedOutput && savedOutput.lines) showOutput(id, savedOutput.lines, savedOutput.hasError, savedOutput.time, savedOutput.isAsync);

            updateCellCount();
            return id;
        }

        function buildBannerHTML(cellId, linkedQuestionId) {
            const q = linkedQuestionId ? dsaQuestions.find(x => x.id === linkedQuestionId) : null;
            return '<div class="cell-qbanner ' + (q ? 'linked' : '') + '" id="qbanner-' + cellId + '">' +
                '<span class="qb-icon">' + (q ? 'ğŸ¯' : 'â“') + '</span>' +
                '<div class="qb-info">' +
                '<div class="qb-sublabel">DSA Question</div>' +
                (q
                    ? '<div class="qb-title">' + escH(q.title) + '</div>' +
                    '<div class="qb-meta"><span class="diff-badge diff-' + q.difficulty + '">' + q.difficulty + '</span>' +
                    '<span style="font-size:0.6rem;color:var(--muted);font-family:\'Space Mono\',monospace">' + escH(q.category || '') + '</span>' +
                    (q.solved ? '<span style="color:var(--success);font-size:0.6rem;font-family:\'Space Mono\',monospace">âœ“ solved</span>' : '') + '</div>'
                    : '<div class="qb-empty">No question linked â€” click to add</div>'
                ) +
                '</div>' +
                '<div class="qb-dropdown-wrap" id="qbdrop-' + cellId + '">' +
                '<button class="qb-link-btn ' + (q ? 'is-linked' : '') + '" onclick="togglePicker(' + cellId + ')">' +
                (q ? 'âœ Change' : '+ Link Question') +
                '</button>' +
                '<div class="qb-picker" id="qbpicker-' + cellId + '" style="display:none">' +
                '<div class="qb-psearch"><input type="text" placeholder="Search..." oninput="filterPicker(' + cellId + ',this.value)" id="qbsearch-' + cellId + '"></div>' +
                '<div class="qb-plist" id="qbplist-' + cellId + '"></div>' +
                '</div>' +
                '</div>' +
                (q ? '<button class="qb-unlink" onclick="unlinkQ(' + cellId + ')">âœ•</button>' : '') +
                '</div>';
        }

        function refreshBanner(cellId) {
            const cell = cells.find(c => c.id === cellId);
            if (!cell) return;
            const banner = document.getElementById('qbanner-' + cellId);
            if (!banner) return;
            // Replace the whole banner element's outer content
            const wrap = banner.parentElement;
            const next = banner.nextSibling;
            banner.remove();
            const tmp = document.createElement('div');
            tmp.innerHTML = buildBannerHTML(cellId, cell.linkedQuestionId);
            wrap.insertBefore(tmp.firstChild, next);
        }

        function getTemplate(lang) {
            if (lang === 'typescript') {
                return '// TypeScript â€” async/await fully supported\nasync function twoSum(nums: number[], target: number): Promise<number[]> {\n  const map = new Map<number, number>();\n  for (let i = 0; i < nums.length; i++) {\n    const complement = target - nums[i];\n    if (map.has(complement)) return [map.get(complement)!, i];\n    map.set(nums[i], i);\n  }\n  return [];\n}\n\n(async () => {\n  const result = await twoSum([2, 7, 11, 15], 9);\n  console.log(result); // [0, 1]\n})();';
            }
            return '// JavaScript â€” async/await fully supported\nasync function twoSum(nums, target) {\n  const map = new Map();\n  for (let i = 0; i < nums.length; i++) {\n    const complement = target - nums[i];\n    if (map.has(complement)) return [map.get(complement), i];\n    map.set(nums[i], i);\n  }\n  return [];\n}\n\n(async () => {\n  const result = await twoSum([2, 7, 11, 15], 9);\n  console.log(result); // [0, 1]\n})();';
        }

        function setLang(id, lang) {
            const cell = cells.find(c => c.id === id);
            if (!cell) return;
            cell.lang = lang;
            document.querySelectorAll('#cell-' + id + ' .lang-btn').forEach(btn => {
                btn.classList.toggle('active', (lang === 'javascript' && btn.textContent === 'JS') || (lang === 'typescript' && btn.textContent === 'TS'));
            });
            triggerAutoSave();
        }

        function deleteCell(id) {
            const idx = cells.findIndex(c => c.id === id);
            if (idx !== -1) { cells.splice(idx, 1); delete cellEditors[id]; document.getElementById('cell-' + id).remove(); updateCellCount(); triggerAutoSave(); }
        }

        function updateCellCount() {
            document.getElementById('cell-count').textContent = cells.length + ' cell' + (cells.length !== 1 ? 's' : '');
            cells.forEach((c, i) => { const el = document.getElementById('cnum-' + c.id); if (el) el.textContent = '[' + (i + 1) + ']'; });
        }

        // â”€â”€ Question Picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function togglePicker(cellId) {
            const picker = document.getElementById('qbpicker-' + cellId);
            const isOpen = picker.style.display !== 'none';
            closeAllPickers();
            if (!isOpen) {
                picker.style.display = 'block';
                buildPickerList(cellId, '');
                setTimeout(() => { const s = document.getElementById('qbsearch-' + cellId); if (s) s.focus(); }, 50);
            }
        }

        function closeAllPickers() {
            document.querySelectorAll('[id^="qbpicker-"]').forEach(el => el.style.display = 'none');
        }

        function filterPicker(cellId, val) { buildPickerList(cellId, val.toLowerCase()); }

        function buildPickerList(cellId, search) {
            const list = document.getElementById('qbplist-' + cellId);
            if (!list) return;
            const cell = cells.find(c => c.id === cellId);
            const filtered = dsaQuestions.filter(q => !search || q.title.toLowerCase().includes(search) || (q.category || '').toLowerCase().includes(search));
            if (filtered.length === 0) { list.innerHTML = '<div class="qb-pempty">No questions found</div>'; return; }
            list.innerHTML = filtered.map(q =>
                '<div class="qb-pitem ' + (cell && cell.linkedQuestionId === q.id ? 'selected' : '') + '" onclick="linkQ(' + cellId + ',\'' + q.id + '\')">' +
                '<span class="diff-badge diff-' + q.difficulty + '">' + q.difficulty[0].toUpperCase() + '</span>' +
                '<span class="qb-pitem-name">' + escH(q.title) + '</span>' +
                '<span style="font-size:0.6rem;color:var(--muted);font-family:\'Space Mono\',monospace">' + escH(q.category || '') + '</span>' +
                '</div>'
            ).join('');
        }

        function linkQ(cellId, qId) {
            const cell = cells.find(c => c.id === cellId);
            if (!cell) return;
            cell.linkedQuestionId = qId;
            closeAllPickers();
            refreshBanner(cellId);
            renderDSASidebar(); renderDSAGrid();
            triggerAutoSave();
        }

        function unlinkQ(cellId) {
            const cell = cells.find(c => c.id === cellId);
            if (!cell) return;
            cell.linkedQuestionId = null;
            refreshBanner(cellId);
            renderDSASidebar(); renderDSAGrid();
            triggerAutoSave();
        }

        // close pickers on outside click
        document.addEventListener('click', e => {
            if (!e.target.closest('[id^="qbdrop-"]') && !e.target.closest('.qb-link-btn')) closeAllPickers();
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ASYNC CODE EXECUTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function runCell(id) {
            const cell = cells.find(c => c.id === id);
            const editor = cellEditors[id];
            if (!cell || !editor) return;

            const code = editor.getValue();
            const lang = cell.lang;
            const runBtn = document.getElementById('runbtn-' + id);
            runBtn.classList.add('running');
            runBtn.textContent = 'â³ Running...';
            document.getElementById('output-' + id).style.display = 'none';

            const logs = [];
            const startTime = performance.now();
            let hasError = false;
            let isAsync = false;

            // Capture console methods
            const saved = {};
            ['log', 'error', 'warn', 'info', 'table', 'dir'].forEach(m => saved[m] = console[m]);

            const capture = type => (...args) => {
                let str;
                try {
                    str = args.map(a => {
                        if (a === null) return 'null';
                        if (a === undefined) return 'undefined';
                        if (a instanceof Error) return a.toString();
                        if (a instanceof Promise) return '[Promise]';
                        if (Array.isArray(a)) return JSON.stringify(a, null, 2);
                        if (typeof a === 'object') { try { return JSON.stringify(a, null, 2); } catch { return String(a); } }
                        return String(a);
                    }).join(' ');
                } catch { str = '[unprintable]'; }
                logs.push({ type, str });
                saved[type](...args);
            };

            console.log = capture('log');
            console.error = capture('error');
            console.warn = capture('warn');
            console.info = capture('info');
            console.table = (...args) => { try { capture('log')(JSON.stringify(args[0], null, 2)); } catch { capture('log')(...args); } };
            console.dir = capture('log');

            try {
                let jsCode = code;

                // TypeScript compile
                if (lang === 'typescript') {
                    try {
                        const result = ts.transpileModule(code, {
                            compilerOptions: { target: ts.ScriptTarget.ES2020, module: ts.ModuleKind.None, strict: false, experimentalDecorators: true },
                            reportDiagnostics: true,
                        });
                        if (result.diagnostics && result.diagnostics.length) {
                            result.diagnostics.forEach(d => {
                                const msg = typeof d.messageText === 'string' ? d.messageText : d.messageText.messageText;
                                logs.push({ type: 'warn', str: '[TS] ' + msg });
                            });
                        }
                        jsCode = result.outputText;
                    } catch (err) {
                        logs.push({ type: 'error', str: '[TypeScript] ' + err.message });
                        hasError = true;
                    }
                }

                if (!hasError) {
                    // Detect async usage
                    isAsync = /\bawait\b|\bPromise\b|async\s+(function|\()/.test(jsCode);

                    // Use AsyncFunction so ALL await expressions (even top-level) work correctly
                    // We wrap the entire code in an async function body
                    const AsyncFunction = (async function () { }).constructor;

                    // Build async wrapper
                    const wrappedCode = `
        "use strict";
        ${jsCode}
      `;

                    const fn = new AsyncFunction(wrappedCode);
                    const retVal = await fn();

                    if (retVal !== undefined && retVal !== null) {
                        try {
                            const display = retVal instanceof Promise ? '[Promise]'
                                : typeof retVal === 'object' ? JSON.stringify(retVal, null, 2)
                                    : String(retVal);
                            logs.push({ type: 'return', str: 'â†’ ' + display });
                        } catch { }
                    }
                }

            } catch (err) {
                if (err instanceof Error) {
                    logs.push({ type: 'error', str: err.toString() });
                    if (err.stack) {
                        err.stack.split('\n').slice(1, 4).forEach(l => {
                            const clean = l.trim().replace(/^\s*at\s+/, 'at ');
                            if (clean) logs.push({ type: 'error', str: '  ' + clean });
                        });
                    }
                } else {
                    logs.push({ type: 'error', str: String(err) });
                }
                hasError = true;
            } finally {
                ['log', 'error', 'warn', 'info', 'table', 'dir'].forEach(m => console[m] = saved[m]);
            }

            const elapsed = (performance.now() - startTime).toFixed(1);
            if (logs.length === 0) logs.push({ type: 'info', str: '(no output)' });

            showOutput(id, logs, hasError, elapsed + 'ms', isAsync);
            runBtn.classList.remove('running');
            runBtn.innerHTML = 'â–¶ Run';
            cell.lastOutput = { lines: logs, hasError, time: elapsed + 'ms', isAsync };
            triggerAutoSave();
        }

        function showOutput(id, logs, hasError, time, isAsync) {
            const el = document.getElementById('output-' + id);
            const content = document.getElementById('ocontent-' + id);
            const timeEl = document.getElementById('otime-' + id);
            const asyncBadge = document.getElementById('oasync-' + id);
            el.style.display = 'block';
            if (time) timeEl.textContent = time;
            if (asyncBadge) asyncBadge.style.display = isAsync ? 'inline' : 'none';
            content.className = 'out-content ' + (hasError ? 'has-error' : 'has-success');
            content.innerHTML = logs.map(({ type, str }) => {
                const cls = type === 'error' ? 'error-line' : type === 'warn' ? 'warn-line' : type === 'info' ? 'info-line' : type === 'return' ? 'return-line' : 'log-line';
                const pfx = type === 'error' ? 'âœ– ' : type === 'warn' ? 'âš  ' : type === 'return' ? '' : '';
                return '<div class="' + cls + '">' + pfx + escH(str) + '</div>';
            }).join('');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SAVE / LOAD
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function triggerAutoSave() {
            document.getElementById('save-dot').classList.remove('saved');
            document.getElementById('save-text').textContent = 'Unsaved...';
            document.getElementById('save-bar').classList.add('visible');
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(saveAll, 2200);
        }

        async function saveAll() {
            const title = document.getElementById('nb-title').value.trim() || 'Untitled Notebook';
            const cellsData = cells.map(c => {
                const editor = cellEditors[c.id];
                const wrap = document.getElementById('cell-' + c.id);
                const desc = wrap ? wrap.querySelector('.desc-ta').value : c.description || '';
                return { lang: c.lang, code: editor ? editor.getValue() : '', description: desc, output: c.lastOutput || null, linkedQuestionId: c.linkedQuestionId || null };
            });

            localStorage.setItem('current_notebook', JSON.stringify({ title, cells: cellsData, updatedAt: Date.now() }));
            persistDSA();

            const bar = document.getElementById('save-bar');
            const dot = document.getElementById('save-dot');
            const txt = document.getElementById('save-text');

            if (!db) {
                dot.classList.add('saved'); txt.textContent = 'Saved locally';
                setTimeout(() => bar.classList.remove('visible'), 2200); return;
            }
            try {
                const payload = { title, cells: cellsData, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
                if (currentNotebookId) {
                    await db.collection('notebooks').doc(currentNotebookId).set(payload);
                } else {
                    const ref = await db.collection('notebooks').add(payload);
                    currentNotebookId = ref.id;
                    document.getElementById('nb-id').textContent = ref.id.slice(0, 8) + '...';
                }
                dot.classList.add('saved'); txt.textContent = 'Saved to Firebase âœ“';
                loadNotebooksList();
                setTimeout(() => bar.classList.remove('visible'), 2200);
            } catch (e) {
                txt.textContent = 'Save failed: ' + e.message;
                setTimeout(() => bar.classList.remove('visible'), 3000);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // HELPERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function escH(str) { return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.className = 'toast show ' + (type || '');
            setTimeout(() => t.className = 'toast', 2700);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // KEYBOARD
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveAll(); }
            if (e.key === 'Escape') {
                closeAllPickers();
                document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INIT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        window.addEventListener('load', () => {
            // Load DSA
            try { dsaQuestions = JSON.parse(localStorage.getItem('dsa_questions') || '[]'); } catch (e) { dsaQuestions = []; }
            renderDSASidebar(); updateDSAStats(); pickDiff('medium');

            // Load notebook
            try {
                const local = JSON.parse(localStorage.getItem('current_notebook') || 'null');
                if (local) {
                    document.getElementById('nb-title').value = local.title || 'Untitled Notebook';
                    if (local.cells && local.cells.length) {
                        local.cells.forEach(c => addCell(c.lang, c.code, c.description, c.output, c.linkedQuestionId));
                    } else { addCell('javascript'); }
                } else { addCell('javascript'); }
            } catch (e) { addCell('javascript'); }

            // Auto-reconnect Firebase
            const fc = JSON.parse(localStorage.getItem('fb_config') || '{}');
            if (fc.apiKey) {
                ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'].forEach(k => {
                    const el = document.getElementById('fb-' + k); if (el) el.value = fc[k] || '';
                });
                initFirebase().catch(() => { });
            }
        });
    </script>
</body>

</html>